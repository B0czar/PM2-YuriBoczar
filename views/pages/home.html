<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sistema de Gerenciamento</title>
        <link rel="stylesheet" href="../css/styles.css" />
    </head>
    <body>
        <nav class="navbar">
            <div class="container">
                <h1>Sistema de Gerenciamento</h1>
            </div>
        </nav>

        <div class="container">
            <div class="tabs">
                <div class="tab active" data-tab="users">Usuários</div>
                <div class="tab" data-tab="categories">Categorias</div>
                <div class="tab" data-tab="tasks">Tarefas</div>
            </div>

            <!-- Seção de Usuários -->
            <div class="tab-content active" id="users">
                <div class="card">
                    <h2>Novo Usuário</h2>
                    <form id="userForm">
                        <div class="form-group">
                            <label for="userName">Nome</label>
                            <input
                                type="text"
                                id="userName"
                                class="form-control"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input
                                type="email"
                                id="userEmail"
                                class="form-control"
                                required
                            />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Adicionar Usuário
                        </button>
                    </form>
                </div>
                <div class="card">
                    <h2>Lista de Usuários</h2>
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Seção de Categorias -->
            <div class="tab-content" id="categories">
                <div class="card">
                    <h2>Nova Categoria</h2>
                    <form id="categoryForm">
                        <div class="form-group">
                            <label for="categoryName">Nome da Categoria</label>
                            <input
                                type="text"
                                id="categoryName"
                                class="form-control"
                                required
                            />
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Adicionar Categoria
                        </button>
                    </form>
                </div>
                <div class="card">
                    <h2>Lista de Categorias</h2>
                    <table class="table" id="categoriesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Seção de Tarefas -->
            <div class="tab-content" id="tasks">
                <div class="card">
                    <h2>Nova Tarefa</h2>
                    <form id="taskForm">
                        <div class="form-group">
                            <label for="taskTitle">Título</label>
                            <input
                                type="text"
                                id="taskTitle"
                                class="form-control"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="taskDescription">Descrição</label>
                            <textarea
                                id="taskDescription"
                                class="form-control"
                                required
                            ></textarea>
                        </div>
                        <div class="form-group">
                            <label for="taskUser">Usuário</label>
                            <select
                                id="taskUser"
                                class="form-control"
                                required
                            ></select>
                        </div>
                        <div class="form-group">
                            <label for="taskCategory">Categoria</label>
                            <select
                                id="taskCategory"
                                class="form-control"
                                required
                            ></select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            Adicionar Tarefa
                        </button>
                    </form>
                </div>
                <div class="card">
                    <h2>Lista de Tarefas</h2>
                    <table class="table" id="tasksTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Descrição</th>
                                <th>Usuário</th>
                                <th>Categoria</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // Funções auxiliares
            const API_URL = "/api";
            const showAlert = (message, type = "success") => {
                const alert = document.createElement("div");
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                document
                    .querySelector(".container")
                    .insertBefore(alert, document.querySelector(".tabs"));
                setTimeout(() => alert.remove(), 3000);
            };

            // Gerenciamento de Tabs
            document.querySelectorAll(".tab").forEach((tab) => {
                tab.addEventListener("click", () => {
                    document
                        .querySelectorAll(".tab")
                        .forEach((t) => t.classList.remove("active"));
                    document
                        .querySelectorAll(".tab-content")
                        .forEach((c) => c.classList.remove("active"));
                    tab.classList.add("active");
                    document
                        .getElementById(tab.dataset.tab)
                        .classList.add("active");
                });
            });

            // Funções para Usuários
            const loadUsers = async () => {
                try {
                    const response = await fetch(`${API_URL}/users`);
                    const users = await response.json();
                    const tbody = document.querySelector("#usersTable tbody");
                    tbody.innerHTML = "";
                    users.forEach((user) => {
                        tbody.innerHTML += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteUser(${user.id})">Excluir</button>
                            </td>
                        </tr>
                    `;
                    });
                    updateUserSelects();
                } catch (error) {
                    showAlert("Erro ao carregar usuários", "error");
                }
            };

            const createUser = async (e) => {
                e.preventDefault();
                const userData = {
                    name: document.getElementById("userName").value,
                    email: document.getElementById("userEmail").value,
                };
                try {
                    await fetch(`${API_URL}/users`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(userData),
                    });
                    showAlert("Usuário criado com sucesso!");
                    e.target.reset();
                    loadUsers();
                } catch (error) {
                    showAlert("Erro ao criar usuário", "error");
                }
            };

            const deleteUser = async (id) => {
                if (!confirm("Tem certeza que deseja excluir este usuário?"))
                    return;
                try {
                    await fetch(`${API_URL}/users/${id}`, { method: "DELETE" });
                    showAlert("Usuário excluído com sucesso!");
                    loadUsers();
                } catch (error) {
                    showAlert("Erro ao excluir usuário", "error");
                }
            };

            // Funções para Categorias
            const loadCategories = async () => {
                try {
                    const response = await fetch(`${API_URL}/categories`);
                    const categories = await response.json();
                    const tbody = document.querySelector(
                        "#categoriesTable tbody"
                    );
                    tbody.innerHTML = "";
                    categories.forEach((category) => {
                        tbody.innerHTML += `
                        <tr>
                            <td>${category.id}</td>
                            <td>${category.name}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Excluir</button>
                            </td>
                        </tr>
                    `;
                    });
                    updateCategorySelects();
                } catch (error) {
                    showAlert("Erro ao carregar categorias", "error");
                }
            };

            const createCategory = async (e) => {
                e.preventDefault();
                const categoryData = {
                    name: document.getElementById("categoryName").value,
                };
                try {
                    await fetch(`${API_URL}/categories`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(categoryData),
                    });
                    showAlert("Categoria criada com sucesso!");
                    e.target.reset();
                    loadCategories();
                } catch (error) {
                    showAlert("Erro ao criar categoria", "error");
                }
            };

            const deleteCategory = async (id) => {
                if (!confirm("Tem certeza que deseja excluir esta categoria?"))
                    return;
                try {
                    await fetch(`${API_URL}/categories/${id}`, {
                        method: "DELETE",
                    });
                    showAlert("Categoria excluída com sucesso!");
                    loadCategories();
                } catch (error) {
                    showAlert("Erro ao excluir categoria", "error");
                }
            };

            // Funções para Tarefas
            const loadTasks = async () => {
                try {
                    const response = await fetch(`${API_URL}/tasks`);
                    const tasks = await response.json();
                    const tbody = document.querySelector("#tasksTable tbody");
                    tbody.innerHTML = "";
                    tasks.forEach((task) => {
                        tbody.innerHTML += `
                        <tr>
                            <td>${task.id}</td>
                            <td>${task.title}</td>
                            <td>${task.description}</td>
                            <td>${task.user_name || "N/A"}</td>
                            <td>${task.category_name || "N/A"}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteTask(${
                                    task.id
                                })">Excluir</button>
                            </td>
                        </tr>
                    `;
                    });
                } catch (error) {
                    showAlert("Erro ao carregar tarefas", "error");
                }
            };

            const createTask = async (e) => {
                e.preventDefault();
                const taskData = {
                    title: document.getElementById("taskTitle").value,
                    description:
                        document.getElementById("taskDescription").value,
                    user_id: document.getElementById("taskUser").value,
                    category_id: document.getElementById("taskCategory").value,
                };
                try {
                    await fetch(`${API_URL}/tasks`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(taskData),
                    });
                    showAlert("Tarefa criada com sucesso!");
                    e.target.reset();
                    loadTasks();
                } catch (error) {
                    showAlert("Erro ao criar tarefa", "error");
                }
            };

            const deleteTask = async (id) => {
                if (!confirm("Tem certeza que deseja excluir esta tarefa?"))
                    return;
                try {
                    await fetch(`${API_URL}/tasks/${id}`, { method: "DELETE" });
                    showAlert("Tarefa excluída com sucesso!");
                    loadTasks();
                } catch (error) {
                    showAlert("Erro ao excluir tarefa", "error");
                }
            };

            // Funções para atualizar selects
            const updateUserSelects = async () => {
                try {
                    const response = await fetch(`${API_URL}/users`);
                    const users = await response.json();
                    const select = document.getElementById("taskUser");
                    select.innerHTML =
                        '<option value="">Selecione um usuário</option>';
                    users.forEach((user) => {
                        select.innerHTML += `<option value="${user.id}">${user.name}</option>`;
                    });
                } catch (error) {
                    console.error(
                        "Erro ao carregar usuários para select:",
                        error
                    );
                }
            };

            const updateCategorySelects = async () => {
                try {
                    const response = await fetch(`${API_URL}/categories`);
                    const categories = await response.json();
                    const select = document.getElementById("taskCategory");
                    select.innerHTML =
                        '<option value="">Selecione uma categoria</option>';
                    categories.forEach((category) => {
                        select.innerHTML += `<option value="${category.id}">${category.name}</option>`;
                    });
                } catch (error) {
                    console.error(
                        "Erro ao carregar categorias para select:",
                        error
                    );
                }
            };

            // Event Listeners
            document
                .getElementById("userForm")
                .addEventListener("submit", createUser);
            document
                .getElementById("categoryForm")
                .addEventListener("submit", createCategory);
            document
                .getElementById("taskForm")
                .addEventListener("submit", createTask);

            // Carregar dados iniciais
            loadUsers();
            loadCategories();
            loadTasks();
        </script>
    </body>
</html>
